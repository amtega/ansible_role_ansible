---
# Tasks for testing role

- name: configure docker sandbox environment
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      docker_presets_images_json_query: >-
        [? starts_with(name, `centos-6`)
           || starts_with(name, `centos-7`)
           || starts_with(name, `debian-9`)
           || starts_with(name, `fedora-27`)
           || starts_with(name, `fedora-28`) ]
  tags:
    - sandbox

- name: run idempotence test
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: started
  tags:
    - sandbox

- name: test ansible role
  hosts: docker_sandbox_containers
  roles:
    - role: amtega.ansible
      ansible_required_version: 2.6.0
      ansible_defaults_inventory: /etc/ansible/hosts
      ansible_defaults_roles_path: /etc/ansible/roles
      ansible_defaults_remote_tmp: /root/.ansible/tmp
      ansible_defaults_forks: 5
      ansible_inventory_enable_plugins:
        - host_list
        - script
        - yaml
        - ini
      ansible_ssh_generate_key: true
      ansible_ssh_key_comment: Ansible key
      ansible_ssh_key_bits: 4096
      ansible_ssh_key_file: .ssh/id_rsa_ansible
      ansible_ssh_key_type: rsa
      ansible_ssh_key_passphrase: rootroot
  tasks:
    - name: get ansible version
      shell: "ansible --version"
      changed_when: false
      register: ansible_version_result

    - name: check that ansible version is correct
      assert:
        that: ansible_version_result.stdout_lines[0] == "ansible 2.6.0"

    - name: read ansible config file
      shell: cat {{ ansible_config_file }}
      changed_when: false
      register: read_config_result

    - name: verify config file content
      assert:
        that:
          - >-
            read_config_result.stdout
            is search("inventory = /etc/ansible/hosts")
          - >-
            read_config_result.stdout
            is search("roles_path = /etc/ansible/roles")
          - >-
            read_config_result.stdout
            is search("remote_tmp = /root/.ansible/tmp")
          - >-
            read_config_result.stdout
            is search("forks = 5")
          - >-
            read_config_result.stdout
            is search("enable_plugins = host_list,script,yaml,ini")

    - name: search key file
      stat:
        path: "~/.ssh/id_rsa_ansible"
      register: check_key_result

    - name: check key file exist
      assert:
        that:
          - check_key_result.stat.exists
  tags:
    - idempotence

- name: cleanup docker docker sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: absent
  tags:
    - sandbox
